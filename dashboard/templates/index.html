<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIDS SOC Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html,
        body {
            height: 100vh;
            margin: 0;
            overflow: hidden;
            /* Lock the main window scroll */
            background-color: #0f1214;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Scrollable Main Content Area */
        .main-container {
            height: 100vh;
            overflow-y: auto;
            /* Internal scrolling only */
            padding-bottom: 2rem;
        }

        .card {
            background-color: #1a1d21;
            border: 1px solid #2c3036;
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #23272b;
            border-bottom: 1px solid #2c3036;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .navbar {
            background-color: #1a1d21 !important;
            border-bottom: 1px solid #2c3036;
            flex-shrink: 0;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .text-high {
            color: #ff4d4d;
        }

        .text-medium {
            color: #ffcc00;
        }

        .text-low {
            color: #00cc66;
        }

        .table {
            --bs-table-bg: transparent;
            color: #b0b3b8;
        }

        .badge-high {
            background-color: #ff4d4d;
            color: white;
        }

        .badge-medium {
            background-color: #ffcc00;
            color: black;
        }

        .badge-low {
            background-color: #00cc66;
            color: white;
        }

        /* Chart Containers - Critical for correct resizing */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <nav class="navbar navbar-dark mb-4 sticky-top">
            <div class="container-fluid">
                <span class="navbar-brand mb-0 h1">üõ°Ô∏è NIDS SOC DASHBOARD</span>
                <span class="badge bg-danger">LIVE MONITORING</span>
            </div>
        </nav>

        <div class="container-fluid px-4">
            <!-- Summary Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total Alerts</h6>
                            <p class="metric-value" id="total-alerts">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">High Risk</h6>
                            <p class="metric-value text-high" id="high-risk">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Medium Risk</h6>
                            <p class="metric-value text-medium" id="medium-risk">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Unique Attackers</h6>
                            <p class="metric-value" id="unique-ips">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">Attack Types</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card h-100">
                        <div class="card-header">Alerts Over Time</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="lineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card h-100">
                        <div class="card-header">Protocol Usage</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="row mt-2">
                <!-- Feed -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">Alert History (All Time)</div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover align-middle mb-0">
                                    <thead style="position: sticky; top: 0; background-color: #1a1d21; z-index: 1;">
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Severity</th>
                                            <th>Type</th>
                                            <th>Source IP</th>
                                            <th>Detail</th>
                                        </tr>
                                    </thead>
                                    <tbody id="alerts-table">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Top IPs -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">Top Attacking IPs</div>
                        <ul class="list-group list-group-flush" id="ip-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart Configuration
        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#2c3036';

        const chartOptions = { responsive: true, maintainAspectRatio: false };

        const barCtx = document.getElementById('barChart').getContext('2d');
        const barChart = new Chart(barCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Count', data: [], backgroundColor: '#36A2EB' }] },
            options: chartOptions
        });

        const lineCtx = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(lineCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Alerts', data: [], borderColor: '#FF6384', tension: 0.4, fill: true, backgroundColor: 'rgba(255, 99, 132, 0.1)' }] },
            options: chartOptions
        });

        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: { labels: [], datasets: [{ data: [], backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'] }] },
            options: chartOptions
        });

        function updateBadges(severity) {
            if (severity === 'HIGH') return 'badge-high';
            if (severity === 'MEDIUM') return 'badge-medium';
            return 'badge-low';
        }

        function fetchStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;

                    const summary = data.summary;
                    document.getElementById('total-alerts').innerText = summary.total;
                    document.getElementById('high-risk').innerText = summary.high;
                    document.getElementById('medium-risk').innerText = summary.medium;
                    document.getElementById('unique-ips').innerText = summary.unique_ips;

                    // Bar Chart (Types)
                    barChart.data.labels = Object.keys(data.charts.types);
                    barChart.data.datasets[0].data = Object.values(data.charts.types);
                    barChart.update();

                    // Line Chart (Time)
                    lineChart.data.labels = Object.keys(data.charts.timeline);
                    lineChart.data.datasets[0].data = Object.values(data.charts.timeline);
                    lineChart.update();

                    // Pie Chart (Protocols)
                    pieChart.data.labels = Object.keys(data.charts.protocols);
                    pieChart.data.datasets[0].data = Object.values(data.charts.protocols);
                    pieChart.update();

                    // Feed
                    const table = document.getElementById('alerts-table');
                    table.innerHTML = '';
                    data.recent.forEach(alert => {
                        table.innerHTML += `<tr>
                            <td><small>${alert.timestamp.split(' ')[1]}</small></td>
                            <td><span class="badge ${updateBadges(alert.severity)}">${alert.severity}</span></td>
                            <td>${alert.type}</td>
                            <td class="font-monospace">${alert.source_ip}</td>
                            <td><small class="text-muted">${alert.message.substring(0, 50)}...</small></td>
                        </tr>`;
                    });

                    // Top IPs
                    const ipList = document.getElementById('ip-list');
                    ipList.innerHTML = '';
                    data.top_ips.forEach(ip => {
                        ipList.innerHTML += `<li class="list-group-item bg-transparent text-light d-flex justify-content-between align-items-center">
                            ${ip.ip}
                            <span class="badge bg-secondary rounded-pill">${ip.count}</span>
                        </li>`;
                    });
                });
        }

        setInterval(fetchStats, 2000);
        fetchStats();
    </script>
</body>

</html>